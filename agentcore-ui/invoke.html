<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentCore Invoke</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .config { margin-bottom: 15px; }
    .config label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
    .config input { width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    .session-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
    .session-row .field { flex: 1; }
    .session-row select { width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; background: white; }
    .session-row button { padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
    .session-row button.new { background: #dc3545; }
    .session-info { font-size: 11px; color: #666; margin-top: 4px; font-family: monospace; word-break: break-all; }
    .chat { border: 1px solid #ccc; border-radius: 4px; height: 380px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
    .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; max-width: 80%; white-space: pre-wrap; }
    .msg.user { background: #007bff; color: white; margin-left: auto; }
    .msg.agent { background: #e9ecef; }
    .msg.tool { background: #fff3cd; font-size: 12px; font-style: italic; }
    .msg.system { background: #d1ecf1; font-size: 12px; color: #0c5460; }
    .input-row { display: flex; gap: 10px; }
    .input-row input { flex: 1; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    .input-row button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .input-row button:disabled { background: #ccc; }
  </style>
</head>
<body>
  <h1>AgentCore Invoke</h1>

  <div class="config">
    <label>Agent ARN</label>
    <input type="text" id="arn" placeholder="arn:aws:bedrock-agentcore:...">
  </div>

  <div class="session-row">
    <div class="field">
      <label>Session</label>
      <select id="sessionSelect" onchange="onSessionChange()">
        <option value="">-- New Session --</option>
      </select>
      <div class="session-info" id="sessionInfo"></div>
    </div>
    <button onclick="newSession()" class="new">New Session</button>
  </div>

  <div class="chat" id="chat"></div>

  <div class="input-row">
    <input type="text" id="prompt" placeholder="Enter message..." onkeypress="if(event.key==='Enter')send()">
    <button id="sendBtn" onclick="send()">Send</button>
  </div>

  <script>
    let sessionId = "";
    const API = "http://localhost:8080";
    let sessions = JSON.parse(localStorage.getItem("agentcore_sessions") || "[]");

    function renderSessionSelect() {
      const select = document.getElementById("sessionSelect");
      const info = document.getElementById("sessionInfo");

      select.innerHTML = '<option value="">-- New Session --</option>' +
        sessions.map(s =>
          `<option value="${s.id}" ${s.id === sessionId ? 'selected' : ''}>${s.id.slice(0,8)}... | ${s.date} | ${s.msgCount || 0} msgs</option>`
        ).join("");

      info.textContent = sessionId ? `Full ID: ${sessionId}` : "";
    }

    function onSessionChange() {
      const select = document.getElementById("sessionSelect");
      const selectedId = select.value;

      if (selectedId && selectedId !== sessionId) {
        sessionId = selectedId;
        document.getElementById("chat").innerHTML = "";
        addMessage(`Resumed session: ${sessionId}`, "system");
        document.getElementById("sessionInfo").textContent = `Full ID: ${sessionId}`;
      } else if (!selectedId) {
        sessionId = "";
        document.getElementById("chat").innerHTML = "";
        document.getElementById("sessionInfo").textContent = "";
      }
    }

    function newSession() {
      sessionId = "";
      document.getElementById("chat").innerHTML = "";
      renderSessionSelect();
    }

    function saveSession(id) {
      if (!id) return;
      const idx = sessions.findIndex(s => s.id === id);
      if (idx >= 0) {
        sessions[idx].msgCount = (sessions[idx].msgCount || 0) + 1;
        sessions[idx].lastUsed = Date.now();
      } else {
        sessions.unshift({
          id,
          date: new Date().toLocaleString(),
          msgCount: 1,
          lastUsed: Date.now()
        });
      }
      // Keep max 20 sessions, sorted by last used
      sessions.sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0));
      if (sessions.length > 20) sessions = sessions.slice(0, 20);
      localStorage.setItem("agentcore_sessions", JSON.stringify(sessions));
      renderSessionSelect();
    }

    function addMessage(text, type) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = `msg ${type}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    async function send() {
      const arn = document.getElementById("arn").value.trim();
      const prompt = document.getElementById("prompt").value.trim();

      if (!arn || !prompt) return;

      document.getElementById("prompt").value = "";
      document.getElementById("sendBtn").disabled = true;
      addMessage(prompt, "user");

      const agentDiv = addMessage("", "agent");
      let fullText = "";

      try {
        const res = await fetch(`${API}/invoke`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ agent_arn: arn, prompt, session_id: sessionId }),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split("\n");
          buffer = lines.pop();

          for (const line of lines) {
            if (!line.startsWith("data:")) continue;
            const data = JSON.parse(line.slice(5).trim());

            if (data.type === "text") {
              fullText += data.text;
              agentDiv.textContent = fullText;
            } else if (data.type === "tool_use") {
              addMessage(`Tool: ${data.tool_name}`, "tool");
            } else if (data.type === "final") {
              if (data.session_id) {
                sessionId = data.session_id;
                saveSession(sessionId);
              }
            } else if (data.type === "error") {
              agentDiv.textContent = `Error: ${data.error}`;
            }
          }
        }
      } catch (e) {
        agentDiv.textContent = `Error: ${e.message}`;
      }

      document.getElementById("sendBtn").disabled = false;
    }

    // Initialize
    renderSessionSelect();
  </script>
</body>
</html>
