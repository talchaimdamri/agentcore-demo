# Plan: Add S3 File Storage to AgentCore Agent

## Overview
Add S3 storage capability to enable persistent file storage for your Claude agent running on AWS Bedrock AgentCore.

**Approach:** Custom Code Interpreter with S3 execution role (Option B)

**Current State:**
- Agent uses `aws.codeinterpreter.v1` (managed code interpreter)
- Region: `eu-central-1`
- AWS Account: `597088042181`
- No S3 integration exists - files are in isolated Code Interpreter filesystem

**What We'll Create:**
1. S3 bucket: `agentcore-artifacts-597088042181`
2. IAM policy: `AgentCoreS3AccessPolicy`
3. IAM role: `AgentCoreS3ExecutionRole`
4. Custom Code Interpreter: `s3-code-interpreter`

---

# PART 1: AWS INFRASTRUCTURE SETUP (Steps 1-3)

---

## Step 1: Create S3 Bucket (AWS Console)

### 1.1 Navigate to S3
1. Open AWS Console: https://console.aws.amazon.com/s3/
2. Ensure you're in region **eu-central-1** (Frankfurt)

### 1.2 Create the Bucket
1. Click **Create bucket**
2. Configure:
   - **Bucket name**: `agentcore-artifacts-597088042181` (must be globally unique)
   - **Region**: EU (Frankfurt) eu-central-1
   - **Object Ownership**: ACLs disabled (recommended)
   - **Block Public Access**: Keep all blocked (default)
   - **Versioning**: Enable (recommended for safety)
   - **Encryption**: SSE-S3 (default)
3. Click **Create bucket**

### 1.3 Create Folder Structure
Inside the bucket, create these folders:
```
agentcore-artifacts-597088042181/
├── code-interpreter-outputs/    # Files generated by code interpreter
├── uploads/                     # Files uploaded by users
└── sessions/                    # Session-specific artifacts
```

---

## Step 2: Create IAM Role and Permissions

### 2.1 Create IAM Policy

1. Go to IAM Console: https://console.aws.amazon.com/iam/
2. Navigate to **Policies** → **Create policy**
3. Select **JSON** tab and paste:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "S3AgentCoreAccess",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:GetObjectVersion",
                "s3:DeleteObject",
                "s3:ListBucket",
                "s3:GetBucketLocation"
            ],
            "Resource": [
                "arn:aws:s3:::agentcore-artifacts-597088042181",
                "arn:aws:s3:::agentcore-artifacts-597088042181/*"
            ]
        }
    ]
}
```

4. Click **Next**
5. Name the policy: `AgentCoreS3AccessPolicy`
6. Add description: "Allows AgentCore Code Interpreter to read/write S3 bucket"
7. Click **Create policy**

### 2.2 Create IAM Role for Code Interpreter

1. Go to **Roles** → **Create role**
2. Select **Custom trust policy**
3. Paste this trust policy:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "bedrock-agentcore.amazonaws.com"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringEquals": {
                    "aws:SourceAccount": "597088042181"
                }
            }
        }
    ]
}
```

4. Click **Next**
5. Search and select: `AgentCoreS3AccessPolicy` (the policy you just created)
6. Click **Next**
7. Name the role: `AgentCoreS3ExecutionRole`
8. Click **Create role**
9. **Copy the Role ARN** (e.g., `arn:aws:iam::597088042181:role/AgentCoreS3ExecutionRole`)

---

## Step 3: Create Custom Code Interpreter (AWS Console)

### 3.1 Navigate to AgentCore Console
1. Go to: https://console.aws.amazon.com/bedrock-agentcore/home?region=eu-central-1
2. Select **Built-in tools** from navigation

### 3.2 Create Code Interpreter
1. Click **Create Code Interpreter tool**
2. Configure:
   - **Name**: `s3-code-interpreter`
   - **Description**: "Code interpreter with S3 bucket access"
   - **Network settings**: **PUBLIC** (required for S3 access)
   - **IAM runtime role**: Select `AgentCoreS3ExecutionRole`
3. Click **Create**
4. **Copy the Code Interpreter Tool ID** (format: `custom.codeinterpreter.xxxxx`)

---

# PART 2: AGENT CODE UPDATES (Steps 4-5)

---

## Step 4: Update Agent Code

### 4.1 Update code_int_mcp/client.py

**File:** `code_int_mcp/client.py`

Replace the Code Interpreter identifier:

```python
# Before (line ~15)
CODE_INTERPRETER_IDENTIFIER = "aws.codeinterpreter.v1"

# After
CODE_INTERPRETER_IDENTIFIER = "custom.codeinterpreter.xxxxx"  # Your new ID from Step 3
```

### 4.2 Add S3 Tools to MCP Server

**File:** `code_int_mcp/server.py`

Add new tools:

```python
@mcp.tool()
async def upload_to_s3(
    file_path: str,
    s3_key: str,
    code_int_session_id: str = ""
) -> dict:
    """Upload a file from Code Interpreter to S3 bucket.

    Args:
        file_path: Path to file in Code Interpreter (e.g., /tmp/output.csv)
        s3_key: S3 object key (e.g., outputs/analysis.csv)
        code_int_session_id: Session ID for continuity
    """
    code = f'''
import boto3
s3 = boto3.client('s3')
bucket = 'agentcore-artifacts-597088042181'
s3.upload_file('{file_path}', bucket, '{s3_key}')
print(f"Uploaded to s3://{{bucket}}/{s3_key}")
'''
    return await execute_code(code, "python", code_int_session_id)


@mcp.tool()
async def download_from_s3(
    s3_key: str,
    local_path: str,
    code_int_session_id: str = ""
) -> dict:
    """Download a file from S3 to Code Interpreter.

    Args:
        s3_key: S3 object key to download
        local_path: Where to save in Code Interpreter
        code_int_session_id: Session ID for continuity
    """
    code = f'''
import boto3
s3 = boto3.client('s3')
bucket = 'agentcore-artifacts-597088042181'
s3.download_file(bucket, '{s3_key}', '{local_path}')
print(f"Downloaded s3://{{bucket}}/{s3_key} to {local_path}")
'''
    return await execute_code(code, "python", code_int_session_id)


@mcp.tool()
async def list_s3_files(
    prefix: str = "",
    code_int_session_id: str = ""
) -> dict:
    """List files in the S3 bucket.

    Args:
        prefix: Filter by prefix (e.g., 'outputs/')
        code_int_session_id: Session ID for continuity
    """
    code = f'''
import boto3
s3 = boto3.client('s3')
bucket = 'agentcore-artifacts-597088042181'
response = s3.list_objects_v2(Bucket=bucket, Prefix='{prefix}')
for obj in response.get('Contents', []):
    print(f"{{obj['Key']}} ({{obj['Size']}} bytes)")
'''
    return await execute_code(code, "python", code_int_session_id)
```

### 4.3 Update agent.py Tool Definitions

**File:** `agent.py`

Add S3 tools to the `TOOLS` list:

```python
TOOLS = [
    Skill,
    # Existing Code Interpreter tools
    "mcp__codeint__execute_code",
    "mcp__codeint__execute_command",
    "mcp__codeint__write_files",
    "mcp__codeint__read_files",
    # NEW: S3 Storage tools
    "mcp__codeint__upload_to_s3",
    "mcp__codeint__download_from_s3",
    "mcp__codeint__list_s3_files",
    # Browser tools
    "mcp__browser__search_web",
    "mcp__browser__scrape_page",
    "mcp__browser__take_screenshot",
]
```

---

## Step 5: Test and Verify

After implementation, test with these prompts:

1. **Upload test:** "Create a test file and upload it to S3"
2. **List test:** "List all files in the S3 bucket"
3. **Download test:** "Download the test file from S3 and show its contents"

---

## Files to Modify (Step 4)

| File | Changes |
|------|---------|
| `code_int_mcp/client.py` | Update `CODE_INTERPRETER_IDENTIFIER` to custom ID |
| `code_int_mcp/server.py` | Add S3 upload/download/list tools |
| `agent.py` | Add new S3 tools to `TOOLS` list |

---

# QUICK REFERENCE: First Two Steps (Manual AWS Console Steps)

## Step 1 - Create S3 Bucket
1. **Open:** https://console.aws.amazon.com/s3/?region=eu-central-1
2. **Create bucket:** `agentcore-artifacts-597088042181`
3. **Settings:** Enable versioning, keep Block Public Access ON
4. **Create folders:** `code-interpreter-outputs/`, `uploads/`, `sessions/`

## Step 2 - Create IAM Policy & Role
1. **Open:** https://console.aws.amazon.com/iam/
2. **Create Policy:** `AgentCoreS3AccessPolicy` (JSON in Step 2.1 above)
3. **Create Role:** `AgentCoreS3ExecutionRole` with custom trust policy (JSON in Step 2.2 above)
4. **Attach** `AgentCoreS3AccessPolicy` to the role
5. **Save** the Role ARN: `arn:aws:iam::597088042181:role/AgentCoreS3ExecutionRole`

---

After completing Steps 1-2, proceed with Step 3 (Create Custom Code Interpreter) and Step 4 (Update Agent Code).
